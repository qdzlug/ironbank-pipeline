{
  "$schema": "https://json-schema.org/draft/2019-09/schema",
  "$id": "https://repo1.dsop.io/ironbank-tools/ironbank-pipeline/schema/hardening_manifest.schema.json",
  "definitions": {


    "TimestampRegex": {
      "$comment": "TODO: Get this regex",
      "description": "Timestamp in 'YYYY-MM-DD HH:MM:SS' format",
      "type": "string"
    },


    "DockerNameAndTagRegex": {
      "$comment": "https://github.com/docker/distribution/blob/master/reference/regexp.go",
      "type": "string",
      "pattern": "^[a-z0-9]+(?:(?:(?:[._]|__|[-]*)[a-z0-9]+)+)?(?:(?:/[a-z0-9]+(?:(?:(?:[._]|__|[-]*)[a-z0-9]+)+)?)+)?:[\\w][\\w.-]{0,127}$"
    },



    "ContainerStateEnum": {
      "type": "string",
      "description": "Any state other than 'Approved' or 'Conditionally Approved' are considered unapproved",
      "enum": [
        "Approved",
        "Conditionally Approved",
        "Rejected",
        "Under Review",
        "Pending Approval"
      ]
    },


    "FindingStateEnum": {
      "description": "Any state other than 'approved' or 'conditional' are considered unapproved",
      "type": "string",
      "enum": [
        "needs_justification",
        "has_justification",
        "justified",
        "needs_review",
        "needs_rework",
        "reviewed",
        "rejected",
        "conditional",
        "approved"
      ]
    },


    "ScanSourceEnum": {
      "type": "string",
      "description": "Enum of all available scanning tools",
      "enum": [
        "oscap_comp",
        "oscap_cve",
        "anchore_comp",
        "anchore_cve",
        "twistlock_cve"
      ]
    },


    "UserRoleEnum": {
      "type": "string",
      "$comment": "TODO: Find out all of the roles",
      "description": "The roles a user can hold",
      "enum": [
        "container_contributor",
        "container_approver",
        "findings_approver"
      ]
    },


    "UserStrictContainerFindingsApprover": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "email": {
          "type": "string"
        },
        "role": {
          "enum": ["findings_approver", "container_approver"]
        }
      },
      "required": ["name", "email", "role"]
    },


    "UserStrictContainerApprover": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "email": {
          "type": "string"
        },
        "role": {
          "const": "container_approver"
        }
      },
      "required": ["name", "email", "role"]
    },


    "User": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "email": {
          "type": "string"
        },
        "role": {
          "$ref": "#/definitions/UserRoleEnum"
        }
      },
      "required": ["name", "email", "role"]
    },


    "ContainerApprover": {
      "description": "The approver associated with the container (not findings). Only exists if the container is approved",
      "type": "object",
      "properties": {
        "expires": {
          "$ref": "#definitions/TimestampRegex"
        },
        "date": {
          "$ref": "#definitions/TimestampRegex"
        },
        "comment": {
          "type": "string"
        },
        "user": {
          "$ref": "#/definitions/UserStrictContainerApprover"
        }
      },
      "required": ["date", "comment", "user"]
    },


    "FindingsArray": {
      "description": "FindingsArray description",
      "type": "array",
      "items": {
        "$ref": "#/definitions/Finding"
      }
    },


    "Finding": {
      "description": "Findings description",
      "type": "object",
      "properties": {
        "identifier": {
          "description": "TODO: ASCII minus newlines - no whitespace?",
          "type": "string"
        },
        "source": {
          "$ref": "#/definitions/ScanSourceEnum"
        },
        "description": {
          "type": "string"
        },
        "package": {
          "type": "string"
        },
        "findingsState": {
          "$ref": "#/definitions/FindingStateEnum"
        },
        "inheritsFrom": {
          "type": "array",
          "items": [
            { "$ref": "#/definitions/DockerNameAndTagRegex" }
          ]
        },
        "contributor": { "$ref": "#/definitions/FindingsContributor" },
        "reviewer": { "$ref": "#/definitions/FindingsReviewer" },
        "approver": { "$ref": "#/definitions/FindingsApprover" }
      },
      "required": ["identifier", "source", "description", "findingsState"]
    },


    "FindingsContributor": {
      "type": "object",
      "properties": {
        "state": {
          "$ref": "#/definitions/FindingStateEnum"
        },
        "date": {
          "$ref": "#definitions/TimestampRegex"
        },
        "justification": {
          "type": "string"
        },
        "user": {
          "$ref": "#/definitions/User"
        }
      },
      "required": ["state", "date", "justification", "user"]
    },


    "FindingsReviewer": {
      "type": "object",
      "properties": {
        "state": {
          "$ref": "#/definitions/FindingStateEnum"
        },
        "date": {
          "$ref": "#definitions/TimestampRegex"
        },
        "comment": {
          "type": "string"
        },
        "falsePositive": {
          "type": "boolean"
        },
        "user": {
          "$ref": "#/definitions/User"
        }
      },
      "required": ["state", "date", "comment", "user"]
    },


    "FindingsApprover": {
      "type": "object",
      "properties": {
        "state": {
          "$ref": "#/definitions/FindingStateEnum"
        },
        "date": {
          "$ref": "#definitions/TimestampRegex"
        },
        "comment": {
          "type": "string"
        },
        "user": {
          "$ref": "#/definitions/UserStrictContainerFindingsApprover"
        }
      },
      "required": ["state", "date", "comment", "user"]
    }
  },


  "title": "VAT Finding",
  "description": "Finding schema",
  "type": "object",
  "properties": {
    "imageName": {
      "type": "string"
    },
    "imageTag": {
      "type": "string"
    },
    "containerState": {
      "$ref": "#/definitions/ContainerStateEnum"
    },
    "earliestExpiration": {
      "description": "Only exists if either the container OR any of the findings have an expiration. Computed field of the earliest date that either the container or any of the findings expires. This may be a date in the past, if the container or the finding is expired",
      "$ref": "#/definitions/TimestampRegex"
    },
    "approver": {
      "description": "Only exists if the container is approved or conditionally approved",
      "$ref": "#/definitions/ContainerApprover"
    },
    "findings": {
      "$ref": "#/definitions/FindingsArray"
    }
  },
  "required": ["imageName", "imageTag", "containerState", "findings"]
}
