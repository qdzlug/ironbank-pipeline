# You can override the included template(s) by including variable overrides
# See https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#priority-of-environment-variables
image: "registry1.dso.mil/ironbank/ironbank-pipelines/pipeline-runner:v0.9.1"

stages:
  - secret-scanning
  - format
  - lint
  - test

trufflehog:
  needs: []
  tags:
    - ironbank-tools
  stage: secret-scanning
  image: registry1.dso.mil/ironbank/opensource/trufflehog/trufflehog3:3.0.5
  variables:
    # This forces the trufflehog job to NOT perform a shallow clone
    GIT_DEPTH: 0
  script:
    - python3 -m pip install --user .
    - python3 stages/secret-scan/trufflehog.py

shellcheck:
  needs: []
  tags:
    - ironbank-tools
  stage: lint
  image: registry1.dso.mil/ironbank/ironbank-pipelines/shellcheck:v0.8.0
  script:
    - |
      set -o pipefail
      set +e # remove gitlab ci setting
      shopt -s nullglob
      files=()
      while IFS='' read -r -d '' line; do
          files+=("$line")
      done < <(find ./stages -name '*.sh' -print0)
      if [ -n "${files[0]}" ]
      then
        echo " Scanning shell scripts..."
        ( IFS=$'\n'; echo "${files[*]}" )
        shellcheck --exclude=SC2153 --format=gcc -- "${files[@]}"
        ret=$?
      fi

      echo "# Scanning embedded scripts..."
      while IFS= read -r -d '' file; do
        echo "# $file"
        yq -r '.[] | objects | .before_script, .script, .after_script | select(. != null) | join("\n")' "$file" | shellcheck --exclude=SC2153 --format=gcc -s bash -
        yq_ret=$?
        if [ $yq_ret -ne 0 ]
        then
          ret=$yq_ret
        fi
      done < <(find . \( -name '*.yaml' -o  -name '*.yml' ! -path './scripts/analysis/*' \) -print0)
      exit "$ret"

black:
  image: registry1.dso.mil/ironbank/opensource/python/python39:v3.9.13
  needs: []
  tags:
    - ironbank-tools
  stage: format
  script:
    - pip install --user black
    - black --check --diff --color -t py311 .

pylama:
  needs: []
  tags:
    - ironbank-tools
  stage: lint
  script:
    - pip install --user pyflakes==2.4.0
    - pip install --user pylama
    - pylama
## ignore line errors as black has been ran against code.

prettier:
  needs: []
  tags:
    - ironbank-tools
  stage: format
  image: "registry1.dso.mil/ironbank/opensource/nodejs/nodejs14:14.19.1"
  script:
    - npx prettier -c .

pylint:
  needs: []
  tags:
    - ironbank-tools
  stage: lint
  allow_failure: true
  variables:
    PYLINTHOME: $CI_PROJECT_DIR
  before_script:
    - python3 -m pip install --user pylint pylint-exit anybadge
    - python3 -m pip install --user .
  script:
    - mkdir ./pylint
    - pylint stages/ ironbank/ | tee ./pylint/pylint.log || pylint-exit $?
    - PYLINT_SCORE=$(sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' ./pylint/pylint.log)
    - anybadge --label=Pylint --file=pylint/pylint.svg --value="${PYLINT_SCORE}" 3=red 6=orange 9=yellow 10=green
    - echo "Pylint score is '${PYLINT_SCORE}'"
  artifacts:
    paths:
      - ./pylint/
  cache:
    key: pylint-cache
    paths:
      - ./ironbank_1.stats

shfmt:
  needs: []
  tags:
    - ironbank-tools
  stage: format
  image: "registry1.dso.mil/ironbank/redhat/ubi/ubi8:8.6"
  script:
    - dnf install wget -y
    - wget https://github.com/mvdan/sh/releases/download/v3.1.2/shfmt_v3.1.2_linux_amd64
    - chmod a+x shfmt_v3.1.2_linux_amd64
    - "./shfmt_v3.1.2_linux_amd64 -d ."

unit-testing:
  needs: []
  tags:
    - ironbank-tools
  stage: test
  script:
    - python3 -m pip install --user pytest-cov
    - python3 -m pip install --user .
    - python3 -m pytest -m "not slow"
  coverage: '/^TOTAL.+?(\d+\%)$/'
  variables:
    ARTIFACT_DIR: "stages/lint/tests/mock"
    CI_COMMIT_BRANCH: "development"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - ./coverage.xml
