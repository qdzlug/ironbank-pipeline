# You can override the included template(s) by including variable overrides
# See https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#priority-of-environment-variables
stages:
  - format
  - lint
  - test

shellcheck:
  needs: []
  tags:
    - ironbank-tools
  stage: lint
  image: registry.dsop.io/ironbank-tools/ironbank-pipeline/shellcheck
  script:
    - |
      set -o pipefail
      set +e # remove gitlab ci setting
      shopt -s nullglob
      files=()
      while IFS='' read -r -d '' line; do
          files+=("$line")
      done < <(find ./stages -name '*.sh' -print0)
      if [ -n "${files[0]}" ]
      then
        echo " Scanning shell scripts..."
        ( IFS=$'\n'; echo "${files[*]}" )
        shellcheck --exclude=SC2153 --format=gcc -- "${files[@]}"
        ret=$?
      fi

      echo "# Scanning embedded scripts..."
      while IFS= read -r -d '' file; do
        echo "# $file"
        yq -r '.[] | objects | .before_script, .script, .after_script | select(. != null) | join("\n")' "$file" | shellcheck --exclude=SC2153 --format=gcc -s bash -
        yq_ret=$?
        if [ $yq_ret -ne 0 ]
        then
          ret=$yq_ret
        fi
      done < <(find . \( -name '*.yaml' -o  -name '*.yml' ! -path './scripts/analysis/*' \) -print0)
      exit "$ret"

black:
  needs: []
  tags:
    - ironbank-tools
  stage: format
  image: "${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/python:pyyaml"
  script:
    - pip install git+git://github.com/psf/black
    - black --check --diff --color -t py39 .

pylama:
  needs: []
  tags:
    - ironbank-tools
  stage: lint
  image: "${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/python:pyyaml"
  dependencies:
    - black
  script:
    - pip install pylama
    - pylama
## ignore line errors as blacks has been ran against code.

prettier:
  needs: []
  tags:
    - ironbank-tools
  stage: format
  image: "${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/all-in-one-fedora:1.0"
  script:
    - curl -sL https://rpm.nodesource.com/setup_12.x | bash -
    - dnf install -y nodejs
    - npx prettier -c .

shfmt:
  needs: []
  tags:
    - ironbank-tools
  stage: format
  image: "${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/all-in-one-fedora:1.0"
  script:
    - dnf install wget -y
    - wget https://github.com/mvdan/sh/releases/download/v3.1.2/shfmt_v3.1.2_linux_amd64
    - chmod a+x shfmt_v3.1.2_linux_amd64
    - "./shfmt_v3.1.2_linux_amd64 -d ."

unit-testing:
  needs: []
  tags:
    - ironbank-tools
  stage: test
  image: "registry1.dso.mil/ironbank/ironbank-pipelines/pipeline-runner:0.3"
  # TODO: remove pip install for pytest when pytest is added to pipeline-runner image
  script:
    - python3 -m pip install pytest
    - python3 -m pytest --log-cli-level="INFO" --ignore=stages/vat
    - python3 -m pytest -m "not slow" --log-cli-level="INFO" --ignore=stages/vat
