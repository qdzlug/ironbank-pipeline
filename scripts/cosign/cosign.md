# Cosign Signatures

The Iron Bank pipeline now performs cosign signatures on all images pushed to the `ironbank` project within Registry1.

Please see the adjacent pem file, `cosign-certificate.pem` for the public cert used to verify these signatures.

The CA bundle cert can be used to validate the `cosign-certificate.pem` file's authenticity.

## Verifying a Signature

To verify a signature, make sure you have [`cosign` installed](https://github.com/sigstore/cosign#installation).
The path to the certificate file can be a URL or a file path.

```bash
cosign verify --certificate-chain cosign-ca-bundle.pem --cert cosign-certificate.pem registry1.dso.mil/ironbank/redhat/ubi/ubi8:8.6
```

```bash
cosign verify \
--certificate-chain https://repo1.dso.mil/ironbank-tools/ironbank-pipeline/-/raw/master/scripts/cosign/cosign-ca-bundle.pem \
--cert https://repo1.dso.mil/ironbank-tools/ironbank-pipeline/-/raw/master/scripts/cosign/cosign-certificate.pem \
registry1.dso.mil/ironbank/redhat/ubi/ubi8:8.6
```

A successful verify command will display the following

```log
Verification for registry1.dso.mil/ironbank/redhat/ubi/ubi8:8.5 --
The following checks were performed on each of these signatures:
  - The cosign claims were validated
  - The signatures were verified against the specified public key

[{"critical":{"identity":{"docker-reference":"registry1.dso.mil/ironbank/redhat/ubi/ubi8"},"image":{"docker-manifest-digest":"sha256:ec1cac395b78158812d0e670e1843b90faf4e933925b7e1c41f1c2f3ff06ff56"},"type":"cosign container image signature"},"optional":{"Subject":"ironbank@dsop.io"}}
```

## Pulling Cosign Artifacts

Beyond creating image signatures, Cosign is used to generate additional artifacts in support of software supply chain security, such as image SBOMs and Attestations.

These artifacts, as well as their own signature artifacts, can be downloaded and verified using tools such as `cosign` and `oras`, as described in the following sections.

If using `cosign download [command]`, the output will be sent to stdout.
It is recommended to use either `--output-file` or pipe this output to another command.

## Signature

The easiest way to access a signature is to use `cosign download signature`

```bash
cosign download signature <image uri>
```

## Attestations

Attestation artifacts have tags ending in `.att`.  Cosign [attestations](https://github.com/sigstore/cosign/blob/main/specs/ATTESTATION_SPEC.md) provide a means of associating arbitrary artifacts, such as SBOMs, to OCI images in registries.  IronBank attaches SBOMs generated by [`syft`](https://github.com/anchore/syft) as attestations using the follwoing `predicateTypes`:
- `cyclonedx`
- `spdx`
- `spdxjson`

The `payloads` (i.e. the actual attestation content) for these `predicateTypes` are the SBOMs for the image, formatted in accordance with the `predicateType`.  You can read more about these `predicateTypes` [here](https://github.com/anchore/syft#output-formats).

Additonally, IronBank creates two custom `predicates` and attaches these as attestations to all images in registry1.  The `predicateType` for these attestations are:
- `https://vat.dso.mil/api/p1/predicate/beta1`
- `https://repo1.dso.mil/dsop/dccscr/-/raw/master/hardening%20manifest/README.md`

These custom `predicates` have `payloads` that contain the VAT API response returned by VAT as part of the image pipeline and the `hardening_manifest.json` as `payloads` respectively.  These `predicates` are discussed in further detail in the following sections.

### VAT Response Predicate
The VAT response `predicate` contains the response receieved from the VAT API as part of the IronBank pipeline.  The response is received when POSTing scan results, the `hardening_manifest.yaml`, and other compliance data to VAT.

This response and the `predicate` `payload` is forms acts as a signed, offline record attesting that the image has been run through the IronBank pipeline and submitted to VAT, and contains the VAT's compliance check results for wider distribution.

### hardening_manifest.json Predicate
The `hardening_manifest.json` `predicate` contains a json-encoded copy of the `hardening_manifest.yaml`, along with the `LICENSE`, `README.md`, and `access_log`s as a `payload`.  This `predicate` provides useful metadata about a given image that may not be relevent to VAT, and is therefore not contained in the VAT response predicate.

### Verifying Attestations
Attestations, like the images themselves, are signed by Cosign.  These signatures, which are attached to each attestation's [DSSE](https://github.com/secure-systems-lab/dsse/blob/master/envelope.md#dsse-envelope) envelope, can be validated using the following command:

```bash
cosign verify-attestation \
--type (slsaprovenance|link|spdx|spdxjson|cyclonedx|vuln|https://vat.dso.mil/api/p1/predicate/beta1|https://repo1.dso.mil/dsop/dccscr/-/raw/master/hardening%20manifest/README.md)
--output-file cosign-attestation.json \
--certificate-chain https://repo1.dso.mil/ironbank-tools/ironbank-pipeline/-/raw/master/scripts/cosign/cosign-ca-bundle.pem \
--cert https://repo1.dso.mil/ironbank-tools/ironbank-pipeline/-/raw/master/scripts/cosign/cosign-certificate.pem \
registry1.dso.mil/ironbank/docker/scratch:ironbank
```

Note: Because each attestation is individually added to the `.att` OCI artifact as DSSE envelopes, each envelope has its own signature.  Therefore each attestation's signature must be validated individually.

### Downloading and Parsing Attestations

The attestations for any given image in Registry1 contain a body of evidence including access logs, SBOMs, LICENSE files, and `hardening_manifest.yaml` content. In order to download and parse these, use the following script.

```bash
#!/bin/bash
image=registry1.dso.mil/ironbank/redhat/ubi/ubi8:8.6

declare -a predicate_types=("https://vat.dso.mil/api/p1/predicate/beta1" "https://repo1.dso.mil/dsop/dccscr/-/raw/master/hardening%20manifest/README.md" "https://spdx.dev/Document" "https://cyclonedx.org/schema")

for predicate_type in "${predicate_types[@]}"; do
  echo $predicate_type
  case $predicate_type in
    'https://vat.dso.mil/api/p1/predicate/beta1')
      filename=vat_response.json
      ;;
    'https://repo1.dso.mil/dsop/dccscr/-/raw/master/hardening%20manifest/README.md')
      filename=hardening_manifest.json
      ;;
    'https://spdx.dev/Document')
      filename=spdx.json
      ;;
    'https://cyclonedx.org/schema')
      filename=cyclonedx.json
      ;;
  esac
  cosign download attestation $image | \
    jq -r '(.payload | @base64d)' | \
    jq -c 'select( .predicateType == "'$predicate_type'")' | \
    jq > $filename;
done
```

This script will cycle through the attestations, decode them, and stores them as separate files on disk named according to the predicateType.

## SBOM

#TODO
