test_image:
  stage: functional_testing
  variables:
    KUBERNETES_SERVICE_ACCOUNT_OVERWRITE: runtime

  before_script:
    - git clone -b ${PIPELINE_REPO_BRANCH} ${PIPELINE_REPO} ${PIPELINE_REPO_DESTINATION}
    - ls -al ${PIPELINE_REPO_DESTINATION}
    - source ${PIPELINE_REPO_DESTINATION}/stages/functional_testing/library/templates.sh
    - package_auth_setup
    #- pip3 install pyyaml do not need this because it is in the image itself
    - aws eks update-kubeconfig --name ib-zelda-runtime
    - kubectl config view
    #- setup_k8s_resources "functional-testing" # run this as admin (this is already setup by POPS)
    - chmod +x ${PIPELINE_REPO_DESTINATION}/stages/functional_testing/library/run_k8s_test.sh

  script: 
    - poetry shell && python3 ${PIPELINE_REPO_DESTINATION}/stages/functional_testing/library/test.py $CI_PROJECT_DIR
    # Check if /tmp/podmanifest.yaml exists before running the next script
    - if [[ -f "/tmp/podmanifest.yaml" ]]; then ${PIPELINE_REPO_DESTINATION}/stages/functional_testing/library/run_k8s_test.sh; fi
  rules:
    - exists:
        - testing_manifest.yaml
      when: always
    - when: never
  allow_failure: true
  tags: 
    - ironbank-dsop-privileged