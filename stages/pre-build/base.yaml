.pre-build:
  stage: pre-build
  # image: image-registry.openshift-image-registry.svc:5000/jenkins/jenkins-oscap-agent:1.1
  image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/docker-git-bash-python:3.7
  allow_failure: true

import_artifacts:
  extends: .pre-build
  # Arguments.get().download is used to get download items
  # dccscrImport() calls ContributorResource, which performs validation of download.yaml file
  image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/docker-git-bash-python:3.7
  services:
    - docker:dind
  before_script:
    - mkdir -p ${ARTIFACT_FOLDER}/pipeline-artifacts/application-artifacts
    # - sudo pip3 install pyyaml --upgrade
    # - docker pull ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/python:pyyaml
    - docker pull ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/clamav:0.102.4
  script:
    - python3 "${PIPELINE_REPO_DIR}/stages/pre-build/downloader.py" -i ${CI_PROJECT_DIR}/download.yaml -d ${CI_PROJECT_DIR}/pipeline-artifacts/application-artifacts
    # - podman pull ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/docker:dind
    - docker run -v ${ARTIFACT_FOLDER}/pipeline-artifacts/application-artifacts:/scan:ro ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/clamav:0.102.4 | tee ${ARTIFACT_FOLDER}/pipeline-artifacts/application-artifacts/report-clamav-artifacts.txt
    - INFECTED_ARTIFACT_FILES=$(grep -e "^Infected files:" ${ARTIFACT_FOLDER}/pipeline-artifacts/application-artifacts/report-clamav-artifacts.txt | cut -d ' ' -f3)
    - |
      if [ ${INFECTED_ARTIFACT_FILES} -gt 0 ]
      then
        echo Malware detected in vendor/customer artifacts! Number of findings: ${INFECTED_ARTIFACT_FILES}
        exit 1
      fi
  # after_script:
  #   - podman image rm -f ${GITLAB_INTERNAL_REGISTRY}/clamav:0.102.4
  artifacts:
    when: always
    paths:
      - ${ARTIFACT_FOLDER}/pipeline-artifacts/application-artifacts
  variables:
    DOCKER_HOST: tcp://localhost:2375 
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

# image_signature:
#   extends: .import_artifacts
#   allow_failure: true
#   image: image-registry.openshift-image-registry.svc:5000/jenkins/jenkins-oscap-agent:1.1
#   services:
#     - name: docker:dind
#   before_script:
#     - docker version
#   script:
#     - IMAGE=$(grep "FROM" Dockerfile | cut -d " " -f2)
#     - docker trust inspect ${IMAGE} | tee ${CI_PROJECT_DIR}/pipeline-artifacts/report-image-trust.txt
#   artifacts:
#     when: always
#     paths:
#       - ${CI_PROJECT_DIR}/pipeline-artifacts/

