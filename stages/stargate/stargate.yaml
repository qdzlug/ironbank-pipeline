stargate:
  stage: stargate
  resource_group: stargate
  rules:
    # prettier-ignore
    - if: '$CI_COMMIT_BRANCH == "master" && $STARGATE_VARIABLE'
  dependencies:
    - load-scripts
    - lint
    - build
    - upload-to-s3
  variables:
    ARCHIVE_DIR: ${CI_PROJECT_NAME}
  script:
    - 'find ./reports -name "*.xlsx" -print0 | xargs -0 rm'
    - 'mkdir "${ARCHIVE_DIR}"'
    - 'mv reports "${ARCHIVE_DIR}"'
    - 'echo "${IB_CONTAINER_GPG_KEY}" | base64 -d >key'
    - 'echo "${IB_CONTAINER_GPG_PUBKEY}" >key.pub'
    - 'gpg --import --batch --pinentry-mode loopback --passphrase "${IB_CONTAINER_SIG_KEY_PASSPHRASE}" key'
    - 'pip install --user --quiet "${PIPELINE_REPO_DIR}"'
    - 'python3 "${PIPELINE_REPO_DIR}/stages/stargate/stargate_artifact_push.py"'
  artifacts:
    paths:
      - metadata.json
      - ${ARCHIVE_DIR}
    when: always
    expire_in: 1 week
