build:
  stage: build

  image: ${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/rootless-build:1.3
  dependencies:
    - import artifacts
    - load scripts
  tags:
    - ironbank-isolated
  variables:
    ARTIFACT_DIR: ${ARTIFACT_STORAGE}/build
    IMAGE_FILE: ${CI_PROJECT_NAME}-${IMG_VERSION}
  before_script:
    - IM_NAME=$(echo ${CI_PROJECT_PATH} | sed -e 's/.*dsop\/\(.*\)/\1/')
    - mkdir -p ${ARTIFACT_DIR}
    # Load any images used in Dockerfile build
    - |
      if [[ ! -z ${DOCKER_RESOURCE} ]]; then
        for file in ${ARTIFACT_STORAGE}/import-artifacts/images/*; do
          podman load -i ${file} --storage-driver=vfs
        done
      fi
    - |
      if [[ ! -z ${HTTP_RESOURCE} ]]; then
        cp -r ${ARTIFACT_STORAGE}/import-artifacts/external-resources/* .
      fi
    - echo "${SATELLITE_URL} satellite" >> /etc/hosts
    - echo ${DOCKER_AUTH_CONFIG_PULL} | base64 -d >> prod_auth.json
    - echo ${DOCKER_AUTH_CONFIG_STAGING} | base64 -d >> staging_auth.json
  script:
    - echo "IM_NAME=${IM_NAME}" >> build.env
    # Set the tag to eliminate /build/dsop and matching existing project hierarchy format
    - harbor_image_path=${STAGING_REGISTRY_URL}/$IM_NAME:$IMG_VERSION
    - buildah bud --build-arg "BASE_REGISTRY=${BASE_REGISTRY}" --build-arg "BASE_IMAGE=${BASE_IMAGE}" --build-arg "BASE_TAG=${BASE_TAG}" --authfile prod_auth.json --format=docker --storage-driver=vfs -t $harbor_image_path  .
    - buildah tag --storage-driver=vfs $harbor_image_path  $harbor_image_path-${CI_PIPELINE_ID}
    - buildah push --storage-driver=vfs --authfile staging_auth.json $harbor_image_path-${CI_PIPELINE_ID}
    # Provide tar for use in later stages, matching existing tar naming convention
    - skopeo copy --src-authfile staging_auth.json docker://$harbor_image_path-${CI_PIPELINE_ID} docker-archive:${ARTIFACT_DIR}/${IMAGE_FILE}.tar
    - echo "IMAGE_ID=sha256:$(podman inspect --storage-driver=vfs $harbor_image_path --format {{'.Id'}})" >> build.env

  artifacts:
    when: always
    paths:
      - ${ARTIFACT_DIR}/
    expire_in: 1 week
    reports:
      dotenv: build.env

