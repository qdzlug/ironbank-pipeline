build:
  stage: build
  allow_failure: false 
  image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/rootless-build:1.4
  dependencies:
    - import artifacts
  tags:
    - ironbank-isolated
  variables:
    ARTIFACT_DIR: ${ARTIFACT_STORAGE}/build
    IMAGE_FILE: ${CI_PROJECT_NAME}-${IMG_VERSION}
  before_script:
    - mkdir -p ${ARTIFACT_DIR}
    # Load any images used in Dockerfile build
    - |
      if [[ ! -z ${DOCKER_RESOURCE} ]]; then
        for file in ${ARTIFACT_STORAGE}/import-artifacts/images/*; do
          podman load -i "${file}"
        done
      fi
    - |
      if [[ ! -z ${HTTP_RESOURCE} ]]; then
        cp -r ${ARTIFACT_STORAGE}/import-artifacts/external-resources/* .
      fi
    - echo "${SATELLITE_URL} satellite" >> /etc/hosts
  script:
    - image_path=$(echo ${CI_PROJECT_PATH} | sed -e 's/.*dsop\/\(.*\)/\1/')
    - echo "IM_NAME=${image_path}" >> build.env
    # Set the tag to eliminate /build/dsop and matching existing project hierarchy format
    - harbor_image_path=${STAGING_REGISTRY_URL}/$image_path:$IMG_VERSION
    - buildah bud --authfile "${DOCKER_AUTH_CONFIG}" --format=docker --storage-driver=vfs -t $harbor_image_path .
    - buildah push --storage-driver=vfs --authfile "${DOCKER_AUTH_CONFIG_STAGING}" $harbor_image_path
    # Provide tar for use in later stages, matching existing tar naming convention
    - skopeo copy --src-authfile "${DOCKER_AUTH_CONFIG_STAGING}" docker://$harbor_image_path docker-archive:${ARTIFACT_DIR}/${IMAGE_FILE}.tar
    - echo "IMAGE_ID=sha256:$(podman inspect --storage-driver=vfs $harbor_image_path --format {{'.Id'}})" >> build.env
    - cat build.env

  artifacts:
    when: always
    paths:
      - ${ARTIFACT_DIR}/
    reports:
      dotenv: build.env
