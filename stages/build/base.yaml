.build:
  stage: build
  allow_failure: false
  #image: ${GITLAB_INTERNAL_REGISTRY}/platform/docker-git-bash:stable
  image: quay.io/podman/stable:latest
  cache: {}
  #  services:
  #  - name: docker:19.03-dind-rootless
  #    command: ["--experimental"]
  except:
    #refs:
    #  - tags
    #  - triggers
    variables:
      - $DOCKER_BUILD_DISABLED
  variables:
    BUILD_IMAGE: ${GITLAB_INTERNAL_REGISTRY}/${IMAGE_NAME}
  dependencies: []
  script:
    - echo "list working folder contents..."
    - ls -al
    - DOCKER_BUILDKIT=1 docker build
      --tag ${BUILD_IMAGE}:${IMG_VERSION}
      --file ./Dockerfile
      "."
    # Push the newly bumped build image
    - docker push ${BUILD_IMAGE}:$NEW_VERSION
    - echo "Successfully pushed image ${BUILD_IMAGE}:$IMG_VERSION"
  after_script:
    - IMAGE=$(grep "FROM" Dockerfile | cut -d " " -f2)
    - docker image rm -f ${IMAGE}
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/pipeline-artifacts/
  variables:
    DOCKER_HOST: tcp://docker:2375/    
