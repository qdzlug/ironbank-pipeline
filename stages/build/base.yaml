build:
  stage: build
  allow_failure: false
  #TODO add this back in once we have rootless-podman working again
  services: 
    - name: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/rootless-build:1.1
      alias: buildah
      entrypoint: ["buildah"]
      command: ["--security-opt","seccomp=unconfined"]
    
  #image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/all-in-one-fedora:1.0
  dependencies:
    - import artifacts
  variables:
    ARTIFACT_DIR: ${ARTIFACT_STORAGE}/build
    IMAGE_FILE: ${CI_PROJECT_NAME}-${IMG_VERSION}
  #TODO add this back in once we have rootless-build working again
    #tags:
    #- ironbank-isolated
  before_script:
    - mkdir -p ${ARTIFACT_DIR}
    - cp -r ${ARTIFACT_STORAGE}/import-artifacts/* .
    - dnf install -y buildah
  script:
    - repo_path="${CI_PROJECT_DIR}"
    - image_path=(${repo_path:13:200})
    - echo "IM_NAME=${image_path}" >> build.env
    # Set the tag to eliminate /build/dsop and matching existing project hierarchy format
    - harbor_image_path=${STAGING_REGISTRY_URL}/$image_path:$IMG_VERSION
    - buildah bud --authfile "${DOCKER_AUTH_CONFIG}" --format=docker --storage-driver=vfs -t $harbor_image_path .
    - buildah push --storage-driver=vfs --authfile "${DOCKER_AUTH_CONFIG_STAGING}" $harbor_image_path
    # Provide tar for use in later stages, matching existing tar naming convention
    - skopeo copy --src-authfile "${DOCKER_AUTH_CONFIG_STAGING}" docker://$harbor_image_path docker-archive:${ARTIFACT_DIR}/${IMAGE_FILE}.tar
    - echo "IMAGE_ID=sha256:$(podman inspect --storage-driver=vfs $harbor_image_path --format {{'.Id'}})" >> build.env
    - cat build.env

  artifacts:
    when: always
    paths:
      - ${ARTIFACT_DIR}/
    reports:
      dotenv: build.env 

