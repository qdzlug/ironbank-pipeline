anchore scan:
  extends: .scanning
  stage: scanning
  image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/jenkins-oscap-agent:1.1
  variables:
    # put all scan outputs in the scan-results folder
    ANCHORE_SCANS: ${ARTIFACT_STORAGE}/scan-results/anchore
  before_script:
    - mkdir -p "${ANCHORE_SCANS}"
    - pip3 install --user --upgrade anchorecli
  script:
    - anchore-cli --u ${anchore_username} --p ${anchore_password} --url ${anchore_server_address} image add ${DOCKER_IMAGE_PATH}
    - anchore-cli --u ${anchore_username} --p ${anchore_password} --url ${anchore_server_address} image wait ${DOCKER_IMAGE_PATH}
    - python3 ${PIPELINE_REPO_DIR}/stages/scanning/anchore_scan.py --u ${anchore_username} --p ${anchore_password} --url ${anchore_server_address} --image ${DOCKER_IMAGE_PATH} --output ${ANCHORE_SCANS}
    # - cp -f ${PIPELINE_REPO_DIR}/stages/scanning/anchore_gates.json ${ANCHORE_SCANS}/
    # - cp -f ${PIPELINE_REPO_DIR}/stages/scanning/anchore_security.json ${ANCHORE_SCANS}/
  artifacts:
    when: always
    paths:
      - ${ANCHORE_SCANS}/

#  steps

#  retrieve current anchore version as needed

# add image to anchore cli, authenticate with creds

# use pipeline_anchore_vuln_report_gen.py to generate anchore report

# archive artifacts as needed (such as anchore version text file - i.e. the stuff used by VAT and IBFE)
