#!/bin/bash
set -Eeuo pipefail
mkdir -p "${ARTIFACT_DIR}"
DOCKER_IMAGE_PATH=$(podman load -i "${ARTIFACT_STORAGE}/build/${CI_PROJECT_NAME}-${CI_PIPELINE_ID}.tar" | awk '{print $3}')
export DOCKER_IMAGE_PATH
BASE_IMAGE_TYPE=$(podman inspect -f '{{index .Labels "com.redhat.component"}}' "${DOCKER_IMAGE_PATH}")
if [[ "${BASE_IMAGE_TYPE}" == "" ]]; then
  BASE_IMAGE_TYPE=$(podman inspect -f '{{index .Labels "os_type"}}' "${DOCKER_IMAGE_PATH}")
  if [[ "${BASE_IMAGE_TYPE}" == "" ]]; then
    BASE_IMAGE_TYPE=$(podman inspect -f '{{index .Labels "mil.dso.ironbank.os-type"}}' "${DOCKER_IMAGE_PATH}")
    if [[ "${BASE_IMAGE_TYPE}" == "" ]]; then
      LABELS=$(podman inspect -f '{{index .Labels}}' "${DOCKER_IMAGE_PATH}")
      echo "Unknown image type. Can't choose security guide. labels: ${LABELS}"
      exit 1
    fi
  fi
fi

if [[ "${BASE_IMAGE_TYPE}" == 'ubi8-container' || "${BASE_IMAGE_TYPE}" == 'ubi7-container' ]]; then
  OVAL_DATA_URL='https://www.redhat.com/security/data/oval/com.redhat.rhsa-all.xml.bz2'
elif [[ "${BASE_IMAGE_TYPE}" == 'ubi8-minimal-container' || "${BASE_IMAGE_TYPE}" == 'ubi7-minimal-container' ]]; then
  OVAL_DATA_URL='https://www.redhat.com/security/data/oval/com.redhat.rhsa-all.xml.bz2'
elif [[ "${BASE_IMAGE_TYPE}" == 'ol8-container' || "${BASE_IMAGE_TYPE}" == 'ol7-container' ]]; then
  OVAL_DATA_URL='https://linux.oracle.com/security/oval/com.oracle.elsa-all.xml.bz2'
elif [[ "${BASE_IMAGE_TYPE}" == 'debian10-container' ]]; then
  OVAL_DATA_URL='https://www.debian.org/security/oval/oval-definitions-buster.xml'
elif [[ "${BASE_IMAGE_TYPE}" == 'debian9-container' ]]; then
  OVAL_DATA_URL='https://www.debian.org/security/oval/oval-definitions-stretch.xml'
elif [[ "${BASE_IMAGE_TYPE}" == 'ubuntu2004-container' ]]; then
  OVAL_DATA_URL='https://security-metadata.canonical.com/oval/oci.com.ubuntu.focal.usn.oval.xml.bz2'
elif [[ "${BASE_IMAGE_TYPE}" == 'ubuntu1804-container' ]]; then
  OVAL_DATA_URL='https://people.canonical.com/~ubuntu-security/oval/com.ubuntu.bionic.cve.oval.xml.bz2'
elif [[ "${BASE_IMAGE_TYPE}" == 'ubuntu1604-container' ]]; then
  OVAL_DATA_URL='https://people.canonical.com/~ubuntu-security/oval/com.ubuntu.xenial.cve.oval.xml.bz2'
else
  echo "Base Image Type not supported OSCAP Scans"
  exit 1
fi

if [[ $(echo "${OVAL_DATA_URL}" | rev | cut -d. -f1 | rev) == "bz2" ]]; then
  curl "${OVAL_DATA_URL}" >cve-oval.xml.bz2
  bzip2 -d cve-oval.xml.bz2
else
  curl "${OVAL_DATA_URL}" >cve-oval.xml
fi

oscap --v
oscap-podman "${DOCKER_IMAGE_PATH}" oval eval --results "${ARTIFACT_DIR}/${OSCAP_CVE_XML_FILENAME}" --report "${ARTIFACT_DIR}/${OSCAP_CVE_HTML_FILENAME}" cve-oval.xml
rm -rf cve-oval.xml

echo "OSCAP_CVE_URL=${CI_JOB_URL}" >oscap-cve.env
