openscap compliance rhel:
  extends: .scanning
  stage: scanning
  before_script:
    - "${PIPELINE_REPO_DIR}/stages/scanning/openscap/base_image_type.sh"
    - BASE_IMAGE_TYPE_SHORT = $(echo ${BASE_IMAGE_TYPE} | cut -d- -f1 | sed 's/[0-9]//g')
    - export BASE_IMAGE_TYPE_SHORT
  rules:
    - if: $BASE_IMAGE_TYPE_SHORT != "ubi"
      when: never
    - if: '$DISTROLESS == "1"'
      when: never
  variables:
    OSCAP_SCANS: "${ARTIFACT_STORAGE}/scan-results/openscap"
    OSCAP_FILENAME: "${OSCAP_HTML_FILENAME}"
  # Load in the IMG_VERSION variable from load scripts env
  dependencies:
    - load scripts
    - build
  script:
    - '"${PIPELINE_REPO_DIR}/stages/scanning/openscap/oscap-compliance-run.sh"'
  artifacts:
    when: always
    paths:
      - "${OSCAP_SCANS}"
    reports:
      dotenv: oscap-compliance.env

    expire_in: 1 week

openscap compliance ubuntu:
  extends: .scanning
  stage: scanning
  before_script:
    - "${PIPELINE_REPO_DIR}/stages/scanning/openscap/base_image_type.sh"
    - BASE_IMAGE_TYPE_SHORT = $(echo ${BASE_IMAGE_TYPE} | cut -d- -f1 | sed 's/[0-9]//g')
    - export BASE_IMAGE_TYPE_SHORT
  image: ${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/ubupodscap1804:1.3.2
  rules:
    - if: $BASE_IMAGE_TYPE_SHORT != "ubuntu"
      when: never
    - if: '$DISTROLESS == "1"'
      when: never
  variables:
    OSCAP_SCANS: "${ARTIFACT_STORAGE}/scan-results/openscap"
    OSCAP_FILENAME: "${OSCAP_HTML_FILENAME}"
  # Load in the IMG_VERSION variable from load scripts env
  dependencies:
    - load scripts
    - build
  script:
    - '"${PIPELINE_REPO_DIR}/stages/scanning/openscap/oscap-compliance-run.sh"'
  artifacts:
    when: always
    paths:
      - "${OSCAP_SCANS}"
    reports:
      dotenv: oscap-compliance.env

    expire_in: 1 week
