twistlock-scan:
  extends: .scanning
  stage: scanning

  # Load in the IMAGE_VERSION variable from load-scripts env
  dependencies:
    - load-scripts
    - build
  variables:
    # put all scan outputs in the scan-results folder
    TWISTLOCK_SCANS: "${ARTIFACT_STORAGE}/scan-results/twistlock"
  before_script:
    - mkdir -p "${TWISTLOCK_SCANS}"
  script:
    - |
      curl -s -H "Content-Type: application/json" -H "Authorization: Basic ${TWISTLOCK_API_AUTH}" "${TWISTLOCK_SERVER_ADDRESS}/api/v1/version" >"${TWISTLOCK_SCANS}/twistlock-version.txt"
    - VERSION=$(sed -e 's/"//g' "${TWISTLOCK_SCANS}/twistlock-version.txt" | cut -d"." -f1-2)
    - echo "Downloading twistcli v${VERSION}"
    - |
      curl -s -H "Authorization: Basic ${TWISTLOCK_API_AUTH}" \
        -O "${TWISTLOCK_SERVER_ADDRESS}/api/v${VERSION}/util/twistcli"
    - chmod +x twistcli
    - ./twistcli --version
    - |
      ./twistcli images scan \
        --address "${TWISTLOCK_SERVER_ADDRESS}" \
        --user="${TWISTLOCK_USER}" \
        --password="${TWISTLOCK_PASSWORD}" \
        --containerized \
        --podman-path=podman \
        --output-file "${TWISTLOCK_SCANS}/twistlock_cve.json" \
        --details \
        --custom-labels \
        "${IMAGE_FULLTAG}" >twistlock_cve_details.txt || true
    - ls "${TWISTLOCK_SCANS}/twistlock_cve.json"

  artifacts:
    when: always
    paths:
      - "${TWISTLOCK_SCANS}/"
    expire_in: 1 week
  retry:
    max: 2
    when: always
