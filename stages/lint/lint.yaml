lint:
  stage: lint
  dependencies:
    - load-scripts
  variables:
    ARTIFACT_DIR: "${ARTIFACT_STORAGE}/lint"
    KUBERNETES_SERVICE_ACCOUNT_OVERWRITE: vat
  before_script:
    - 'mkdir -p "${ARTIFACT_DIR}'
  artifacts:
    paths:
      - "${ARTIFACT_DIR}"
    expire_in: 1 week
    when: always
  retry:
    max: 2
    when: runner_system_failure
  script:
    - pip3 install dockerfile
    - |
      if [[ "${CI_COMMIT_BRANCH}" == "master" || "${CI_COMMIT_BRANCH}" == "development" ]] && [[ "${CI_COMMIT_REF_PROTECTED}" != true ]]; then
        echo "This pipeline is running on an unprotected '${CI_COMMIT_BRANCH}' branch. Please protect '${CI_COMMIT_BRANCH}' before running the pipeline on this branch"
        echo "Exiting"
        exit 1
      fi
    - 'python3 "${PIPELINE_REPO_DIR}/stages/lint/base-image-validation.py"'
    - 'python3 "${PIPELINE_REPO_DIR}/stages/lint/container_status_check.py"'
    - '"${PIPELINE_REPO_DIR}/stages/preflight/folder_structure.sh"' # replace folder structure with simple python script
    - 'python3 "${PIPELINE_REPO_DIR}/stages/preflight/metadata.py"'
    - 'python3 "${PIPELINE_REPO_DIR}/stages/lint/pipeline_auth_status.py"'
    - 'python3 "${PIPELINE_REPO_DIR}/stages/preflight/registry-validation.py"'
    - 'python3 "${PIPELINE_REPO_DIR}/stages/lint/vat-api-findings.py"'