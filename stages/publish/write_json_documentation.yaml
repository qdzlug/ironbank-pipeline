white_json_documentation:
  extends: .publish
  image: ${GITLAB_INTERNAL_REGISTRY}/dsop/ironbank-pipeline/all-in-one-fedora:1.0
  variables:
    #TODO: Put these in globals
    IMAGE_FILE: ${CI_PROJECT_NAME}-${IMG_VERSION}
    ARTIFACT_DIR: ${ARTIFACT_STORAGE}/publish/reports
    OPENSCAP_VERSION: ${ARTIFACT_STORAGE}/scanning/openscap_-compliance/openscap-version.txt
    TWISTLOCK_VERSION: ""
  dependencies:
    - build
  before_script:
    - podman load -i ${ARTIFACT_STORAGE}/build/${IMAGE_FILE}.tar ${STAGING_REGISTRY_URL}/${IM_NAME}:${IMG_VERSION}
    - echo ${IB_CONTAINER_GPG_KEY} | base64 -d > key
    - mkdir -p tmp_gpg ${ARTIFACT_DIR}
  script:
    # Gather info for scan-metadata.json
    - GPG_VERSION_INFO=$(gpg --version | grep "gpg")
    - ANCHORE_VERSION=$(curl -k ${anchore_server_address}/version)
    - IMAGE_TAR_SHA=$(sha256sum ${ARTIFACT_STORAGE}/build/${IMAGE_FILE}.tar | grep -E '^[a-zA-Z0-9]+' -o)
    - IMAGE_PODMAN_SHA=$(podman inspect --format {{'.Digest'}} ${STAGING_REGISTRY_URL}/${IM_NAME}:${IMG_VERSION})
    # Create manifest.json
    - |
      cat <<EOF > scan-metadata.json
      {[
        "buildTag": "${IMG_VERSION}",
        "buildNumber": "${CI_COMMIT_SHA}",
        "approval": ""
        "image": {
          "digest": "${IMAGE_TAR_SHA}",
          "sha256": "${IMAGE_PODMAN_SHA}",
        }
        "gpg": {
          "publicKey": "$(cat ${IB_CONTAINER_GPG_PUBKEY})",
          "version":"${GPG_VERION_INFO}"
        }
        "git": {
        }
        "reports": [
          "twistlock": {
            "version": "${TWISTLOCK_VERSION}" 
          },
          "openSCAP": {
            "version": "$(cat ${OPENSCAP_VERSION})" 
          },
          "anchore": {
            "version": "${ANCHORE_VERSION}" 
          }
        ]
      ]}
      EOF
    - cat scan-metadata.json
    # Create manifest.json
    - |
      cat <<EOF > documentation.json
      {
        "timestamp": "$(date +%FT%T)"
      }
      EOF
    - cat documentation.json
    # Stage manifest for upload
  artifacts:
    when: always
    paths:
      - ${ARTIFACT_DIR}
