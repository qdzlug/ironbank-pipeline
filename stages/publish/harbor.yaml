harbor:
  extends: .publish
  image: "${GITLAB_INTERNAL_REGISTRY}/ironbank-tools/ironbank-pipeline/rootless-build:1.3"
  only:
    - master
  dependencies:
    - build
    - load scripts
  script:
    - echo "${DOCKER_AUTH_CONFIG_STAGING}" | base64 -d >> staging_auth.json
    - echo "${DOCKER_AUTH_CONFIG_PROD}" | base64 -d >> prod_auth.json
    # Upload image to prod Harbor
    - |
      skopeo copy --src-authfile staging_auth.json --dest-authfile prod_auth.json \
      "docker://${STAGING_REGISTRY_URL}/${IM_NAME}:${IMG_VERSION}-${CI_PIPELINE_ID}" \
      "docker://${REGISTRY_URL}/${IM_NAME}:${IMG_VERSION}"
