include:
  - local: stages/preflight/base.yaml

trufflehog:
  extends: .preflight
  image:
    name: registry1.dso.mil/ironbank/opensource/trufflehog/trufflehog:2.2.1
    entrypoint: [""]
  script:
    # Could add exceptions using --exclude_paths <exclusion file>
    - WARNINGS=$(trufflehog --json --regex --entropy False --branch $CI_COMMIT_BRANCH ./)
    - SUCCESS=$?
    - |
      if [ $SUCCESS -eq 0 ]; then
      exit 0
      fi
    - 'echo "${WARNINGS}" | jq -C "{reason,branch,commit,commitHash,date,path}"" | tee trufflehog.json'
    - echo "FAILED Trufflehog scan exiting"
    - exit "${SUCCESS}"
