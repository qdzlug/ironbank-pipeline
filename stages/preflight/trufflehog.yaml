trufflehog:
  extends: .preflight
  dependencies: []
  image:
    name: registry1.dso.mil/ironbank/opensource/trufflehog/trufflehog:2.2.1
    entrypoint: [""]
  script:
    - dnf install -y jq
    - set +e
    # - |
    #   git fetch origin -v
    #   if [ "${CI_COMMIT_BRANCH}" == "master" ]; then
    #     echo "Check is run on development and feature branches"
    #     exit 0
    #   elif [ "${CI_COMMIT_BRANCH}" == "development" ]; then
    #     SINCE_COMMIT=$(git log origin/master.. --stat | grep "commit" | tail -1 | awk '{print $2}')
    #   else
    #     SINCE_COMMIT=$(git log origin/development.. --stat | grep "commit" | tail -1 | awk '{print $2}')
    #   fi
    #   export SINCE_COMMIT
    #   # Could add exceptions using --exclude_paths <exclusion file>
    #   WARNINGS=$(trufflehog --regex --entropy False --json --since_commit "${SINCE_COMMIT}" --branch "${CI_COMMIT_BRANCH}" "${CI_PROJECT_URL}")
    #   SUCCESS=$?
    #   export SUCCESS
    - git fetch origin -v
    - |
      if [ "${CI_COMMIT_BRANCH}" == "master" ]; then
        echo "Check is run on development and feature branches"
        exit 0
      elif [ "${CI_COMMIT_BRANCH}" == "development" ]; then
        SINCE_COMMIT=$(git log origin/master.. --stat | grep "commit" | tail -1 | awk '{print $2}')
      else
        SINCE_COMMIT=$(git log origin/development.. --stat | grep "commit" | tail -1 | awk '{print $2}')
      fi
      # Could add exceptions using --exclude_paths <exclusion file>
    - WARNINGS=$(trufflehog --regex --entropy False --json --since_commit "${SINCE_COMMIT}" --branch "${CI_COMMIT_BRANCH}" "${CI_PROJECT_URL}")
    - SUCCESS=$?
      # export SUCCESS
    - set -e
    - |
      if [ $SUCCESS -eq 0 ]; then
        exit 0
      fi
    - 'echo "${WARNINGS}" | jq -C "{reason,branch,commit,commitHash,date,path}"" | tee trufflehog.json | tee trufflehog.json'
    - echo "FAILED Trufflehog scan. Exiting"
    - exit "${SUCCESS}"
  artifacts:
    name: $CI_PROJECT_NAME-$CI_JOB_ID
    when: on_failure
    expire_in: 1 week
    paths:
      - trufflehog.json
